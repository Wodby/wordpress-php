language: bash

sudo: required

services:
  - docker

env:
  global:
    - DOCKER_VERSION=17.06.2
    - LATEST_TAG=7.2
  matrix:
    - TAG=7.2 PHP_VER=7.2
    - TAG=7.1 PHP_VER=7.1
    - TAG=7.0 PHP_VER=7.0
    - TAG=5.6 PHP_VER=5.6
    - TAG=7.2-dev PHP_VER=7.2 PHP_DEV=1
    - TAG=7.1-dev PHP_VER=7.1 PHP_DEV=1
    - TAG=7.0-dev PHP_VER=7.0 PHP_DEV=1
    - TAG=5.6-dev PHP_VER=5.6 PHP_DEV=1

before_install:
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce="${DOCKER_VERSION}~ce-0~ubuntu"

script:
  - make && make test

after_success: |
  if [[ "${TRAVIS_PULL_REQUEST}" == "false" && ("${TRAVIS_BRANCH}" == "master"  || -n "${TRAVIS_TAG}") ]]; then
    docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"

    if [[ -n "${TRAVIS_TAG}" ]]; then
      export STABILITY_TAG="${TRAVIS_TAG}"
    fi

    make release

    if [[ "${TAG}" == "${LATEST_TAG}" ]]; then
      make release TAG="latest"
    fi
  fi

notifications:
  on_failure: never
  slack:
    secure: "DWhLF4Cxu6PGs/zs7XyXHma6HoGy3TpR3qredmB1n8rnPFNuzbG1uJqMwWHgvN5+OaeQQQyoC4zQQOc4O3IWs7pa1F59Lm0ivnvPWw5msrgQoRSaRtVE3t1j4jCfRM5LJnAT2tbubmtX6gX5/8jlGjjL9gDaZDcX3yy5fC/OPAHVQ2ekTva8c8IivmfXeL4P0tsGScDiLYRiwFuQDX5vtPhmqMMJeczq3T2dEzaPQUjZnXBzGrwe+9zv1xzLqwJaYVHI0wRV1UoacElXGo36evzj/NcYiGM0j/wf7J1QI5uzhplw5XMf0+YE8pcrSseCLqyt19l5UjWV6LsLpw8Qt9+4I4DrIlPESm9+mpcV8Wdlp5B7OiLt2/AgXmMZY9IiLVruiqwLf3u6eQ8Uem+68vkRUu2oet/J7UTXozc65y9JeEBlJIAQTunvDGIs2+XQ1ORmzpYWVTTqN7YNk2unt5CTtYn4pl/RT+hPsKJaeAEzdxfY9ZJH72JsMYTKjGrnL7bEeK0S0EsE319a5r4IQRbT2P9GnXqy34wKHzqeNPHAX5nIAeyAJyy5k+D/21ziYwokM3+7qe/mdqPGvZG7wir7XRRUAD4oVAqLmyzi1K85npuFgnmIZVuXGdHoD5TMe7cBJrY2c5QJUZctiOnaH9Z1mK7gdiiRGjYlF3Rx4B8="